-- 系统用户表
CREATE TABLE `user` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
`username` VARCHAR(50) NOT NULL UNIQUE COMMENT '登录用户名',
`password` VARCHAR(255) NOT NULL COMMENT '加密后的密码',
`phone` VARCHAR(20) UNIQUE COMMENT '手机号',
`email` VARCHAR(100) UNIQUE COMMENT '邮箱',
`avatar_url` VARCHAR(255) COMMENT '用户头像',
`role` VARCHAR(20) NOT NULL COMMENT '角色：USER / MERCHANT / DESIGNER / INSPECTOR / ADMIN',
`status` VARCHAR(20) NOT NULL DEFAULT 1 COMMENT ,
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';

-- 设计师扩展信息表
CREATE TABLE `designer` (
`user_id` BIGINT PRIMARY KEY COMMENT '用户ID（与 user 表共享主键）',

`real_name` VARCHAR(50) COMMENT '真实姓名',
`experience_years` INT COMMENT '从业年限',
`style` VARCHAR(100) COMMENT '擅长风格',
`bio` VARCHAR(500) COMMENT '设计师简介',
`rating` DOUBLE COMMENT '设计师评分',
`order_count` INT DEFAULT 0 COMMENT '累计接单数',

`verify_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT '审核状态',
`enabled` TINYINT DEFAULT 1 COMMENT '是否启用',

CONSTRAINT `fk_designer_user`
FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设计师扩展信息表';


-- 管理员扩展信息表
CREATE TABLE `admin` (
`user_id` BIGINT PRIMARY KEY COMMENT '用户ID（与 user 表共享主键）',

`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '成为管理员时间',

CONSTRAINT `fk_admin_user`
FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员扩展信息表';



-- 房屋基础信息
CREATE TABLE house (
house_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '房屋主键',
user_id BIGINT NOT NULL COMMENT '所属用户',
city VARCHAR(50) NOT NULL COMMENT '所在城市（影响设计规范、报价）',
community_name VARCHAR(100) COMMENT '小区名称',
building_no VARCHAR(20) COMMENT '楼栋号',
unit_no VARCHAR(20) COMMENT '单元号',
room_no VARCHAR(20) COMMENT '门牌号',
area DECIMAL(6,2) NOT NULL COMMENT '建筑面积（㎡）',
layout_type VARCHAR(50) COMMENT '户型描述（如 2室1厅1卫）',
floor_count INT COMMENT '总层数',
decoration_type VARCHAR(20) COMMENT '装修类型（full / half / loose）',
confirmed_layout_id BIGINT COMMENT '对应的以确定的layout',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT fk_house_user FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='房屋基础信息表';

-- 房屋布局信息
CREATE TABLE house_layout (
layout_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '布局主键',
house_id BIGINT NOT NULL COMMENT '所属房屋',
designer_id BIGINT COMMENT '布局设计师（Layout阶段）',
furniture_designer_id BIGINT COMMENT '家具设计师（Furniture阶段）',
layout_intent VARCHAR(20) COMMENT '布局意图（KEEP_ORIGINAL / REDESIGN）',
redesign_notes VARCHAR(255) COMMENT '改造需求说明',
layout_version VARCHAR(20) COMMENT '布局版本号（v1 / v2）',
layout_status VARCHAR(20) COMMENT '房屋空间布局状态：DRAFT / SUBMITTED / CONFIRMED / ARCHIVED',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

CONSTRAINT fk_layout_house FOREIGN KEY (house_id) REFERENCES house(house_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='房屋布局信息表';

-- 布局或设计图片
CREATE TABLE house_layout_image (
id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '图片主键',
layout_id BIGINT NOT NULL COMMENT '所属布局方案',
image_url VARCHAR(255) COMMENT '户型图/布局图地址',
image_type VARCHAR(20) COMMENT '图片类型（ORIGINAL / STRUCTURE / FURNITURE）',
image_desc VARCHAR(255) COMMENT '图片说明',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

CONSTRAINT fk_image_layout FOREIGN KEY (layout_id) REFERENCES house_layout(layout_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='布局/设计图片表';


-- 房间信息表（HouseRoom）
CREATE TABLE house_room (
room_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '房间主键',
layout_id BIGINT NOT NULL COMMENT '所属布局方案（Layout = CONFIRMED 后有效）',
designer_id BIGINT NOT NULL COMMENT '上传该房间方案的设计师ID',
floor_no INT COMMENT '所在楼层（1 / 2 / 3）',
room_type VARCHAR(20) COMMENT '空间类型（bedroom / living_room / kitchen / bathroom）',
room_name VARCHAR(50) COMMENT '空间名称（主卧 / 次卧 / 客厅）',
area DECIMAL(6,2) COMMENT '空间面积（㎡）',
has_window BOOLEAN COMMENT '是否有窗',
has_balcony BOOLEAN COMMENT '是否带阳台',
notes VARCHAR(255) COMMENT '用户补充说明',

CONSTRAINT fk_room_layout FOREIGN KEY (layout_id) REFERENCES house_layout(layout_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='房间信息表';


CREATE TABLE furniture_scheme (
scheme_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '家具设计方案主键',
room_id BIGINT NOT NULL COMMENT '所属房间',
designer_id BIGINT NOT NULL COMMENT '设计师ID',
scheme_status VARCHAR(20) COMMENT '状态：draft / submitted / confirmed',
scheme_version VARCHAR(20) COMMENT '方案版本号（v1 / v2 / v3）',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
image_url VARCHAR(255) COMMENT '图片地址',

CONSTRAINT fk_scheme_room
FOREIGN KEY (room_id)
REFERENCES house_room(room_id)
ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='家具设计方案表（房间级）';



CREATE TABLE scheme_room_material (
id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',

scheme_id BIGINT NOT NULL COMMENT '方案ID',
room_id BIGINT NOT NULL COMMENT '房间ID',

-- 地面
floor_material VARCHAR(50) COMMENT '地面材质',
floor_area DECIMAL(6,2) COMMENT '地面面积㎡',

-- 墙面
wall_material VARCHAR(50) COMMENT '墙面材质',
wall_area DECIMAL(6,2) COMMENT '墙面面积㎡',

-- 吊顶
ceiling_material VARCHAR(50) COMMENT '吊顶材质',
ceiling_area DECIMAL(6,2) COMMENT '吊顶面积㎡',

-- 柜体（定制类）
cabinet_material VARCHAR(50) COMMENT '柜体材质',
cabinet_area DECIMAL(6,2) COMMENT '柜体展开面积㎡',

remark VARCHAR(255) COMMENT '设计说明',

created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

FOREIGN KEY (scheme_id) REFERENCES furniture_scheme(scheme_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='房间方案材料汇总表（简化版）';

CREATE TABLE material (
material_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主材ID',
category VARCHAR(20) COMMENT 'FLOOR / WALL / CEILING / CABINET',
type VARCHAR(50) COMMENT '枚举类型值，如 WOOD_FLOOR',
display_name VARCHAR(50) COMMENT '显示名称，如“木地板”',
unit_price DECIMAL(10,2) COMMENT '单价（㎡）',
unit VARCHAR(10) DEFAULT '㎡' COMMENT '单位',
remark VARCHAR(255),
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


CREATE TABLE auxiliary_material (
material_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '辅材ID',
name VARCHAR(50) COMMENT '辅材名称',
category VARCHAR(50) COMMENT 'CEMENT / PIPE / WIRE / ETC',
unit VARCHAR(20) COMMENT '单位：kg/m/个/套',
unit_price DECIMAL(10,2) COMMENT '单价',
remark VARCHAR(255),
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);




CREATE TABLE furniture_image (
image_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '家具设计图ID',
scheme_id BIGINT NOT NULL COMMENT '所属家具设计方案',
image_url VARCHAR(255) NOT NULL COMMENT '图片地址',
image_type VARCHAR(20) COMMENT 'DESIGN / CONFIRMED',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT fk_image_scheme
FOREIGN KEY (scheme_id)
REFERENCES furniture_scheme(scheme_id)
ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='家具设计图片表';


-- 通用账单表（支持定金 + 尾款）
CREATE TABLE `bill` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '账单ID',
`biz_type` VARCHAR(20) NOT NULL COMMENT '业务类型：HOUSE / LAYOUT / FURNITURE / CONSTRUCTION',
`biz_id` BIGINT NOT NULL COMMENT '关联业务对象ID（如 layout_id / scheme_id）',

`amount` DECIMAL(10,2) NOT NULL COMMENT '总金额',
`deposit_amount` DECIMAL(10,2) NOT NULL COMMENT '定金金额',
`pay_status` VARCHAR(20) NOT NULL DEFAULT 'UNPAID'
COMMENT '支付状态：UNPAID / DEPOSIT_PAID / PAID',

`payer_id` BIGINT NOT NULL COMMENT '支付方用户ID',
`payee_id` BIGINT NOT NULL COMMENT '收款方ID（设计师 / 商家 / 平台）',
`deposit_paid_at` DATETIME NULL COMMENT '定金支付时间',
`paid_at` DATETIME NULL COMMENT '尾款支付完成时间',

`remark` VARCHAR(255) NULL COMMENT '备注，例如：第1轮布局设计费',
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '账单创建时间',

-- 防止同一业务阶段重复建账单
UNIQUE KEY `uk_biz_type_biz_id` (`biz_type`, `biz_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通用账单表（支持分阶段支付）';



-- 聊天消息表
CREATE TABLE `chat_message` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
`sender_id` BIGINT NOT NULL COMMENT '发送者用户ID',
`receiver_id` BIGINT NOT NULL COMMENT '接收者用户ID',
`content` VARCHAR(1000) NOT NULL COMMENT '消息内容',
`content_type` VARCHAR(20) NOT NULL DEFAULT 'TEXT' COMMENT '消息类型：TEXT / IMAGE / FILE / LINK',
`timestamp` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',

CONSTRAINT `fk_chat_sender` FOREIGN KEY (`sender_id`) REFERENCES `user`(`id`) ON DELETE CASCADE,
CONSTRAINT `fk_chat_receiver` FOREIGN KEY (`receiver_id`) REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户聊天消息表';


-- 聊天会话状态表
CREATE TABLE `chat_session` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '会话ID',

`user_id` BIGINT NOT NULL COMMENT '当前用户ID（会话视角）',
`partner_id` BIGINT NOT NULL COMMENT '聊天对象用户ID',

last_message_content VARCHAR(1000) COMMENT '最后一条消息内容（摘要）',
last_message_type VARCHAR(20) COMMENT 'TEXT / IMAGE ...',
last_message_time DATETIME COMMENT '最后一条消息时间',

`last_read_time` DATETIME DEFAULT NULL COMMENT '最后一次已读时间',

UNIQUE KEY `uk_user_partner` (`user_id`, `partner_id`),

CONSTRAINT `fk_session_user` FOREIGN KEY (`user_id`)
REFERENCES `user`(`id`) ON DELETE CASCADE,
CONSTRAINT `fk_session_partner` FOREIGN KEY (`partner_id`)
REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='聊天会话状态表';


-- 文章表
CREATE TABLE `post` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '文章ID',
`user_id` BIGINT NOT NULL COMMENT '作者用户ID',
`title` VARCHAR(200) NOT NULL COMMENT '文章标题',
`content` TEXT NOT NULL COMMENT '文章正文',
`like_count` INT NOT NULL DEFAULT 0 COMMENT '点赞数',
`comment_count` INT NOT NULL DEFAULT 0 COMMENT '评论数',
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

CONSTRAINT `fk_post_user`
FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章表';


-- 文章图片表
CREATE TABLE `post_image` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '图片ID',
`post_id` BIGINT NOT NULL COMMENT '所属文章ID',
`image_url` VARCHAR(255) NOT NULL COMMENT '图片地址',
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

CONSTRAINT `fk_post_image_post`
FOREIGN KEY (`post_id`) REFERENCES `post`(`id`)
ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章图片表';


-- 评论表
CREATE TABLE `comment` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '评论ID',
`post_id` BIGINT NOT NULL COMMENT '文章ID',
`user_id` BIGINT NOT NULL COMMENT '评论用户ID',
`content` VARCHAR(500) NOT NULL COMMENT '评论内容',
`like_count` INT NOT NULL DEFAULT 0 COMMENT '评论点赞数',
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

CONSTRAINT `fk_comment_post`
FOREIGN KEY (`post_id`) REFERENCES `post`(`id`)
ON DELETE CASCADE ON UPDATE CASCADE,

CONSTRAINT `fk_comment_user`
FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章评论表';


-- 文章点赞表
CREATE TABLE `post_like` (
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '点赞ID',
`post_id` BIGINT NOT NULL COMMENT '文章ID',
`user_id` BIGINT NOT NULL COMMENT '点赞用户ID',
`created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '点赞时间',

CONSTRAINT `fk_post_like_post`
FOREIGN KEY (`post_id`) REFERENCES `post`(`id`)
ON DELETE CASCADE ON UPDATE CASCADE,

CONSTRAINT `fk_post_like_user`
FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
ON DELETE RESTRICT ON UPDATE CASCADE,

UNIQUE KEY `uk_post_user` (`post_id`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章点赞记录表';
